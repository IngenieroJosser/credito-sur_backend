generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum UserRole {
  SUPER_ADMIN
  COORDINATOR
  SUPERVISOR
  COLLECTOR
  ACCOUNTANT
}

enum RiskLevel {
  GREEN
  YELLOW
  RED
  BLACKLISTED
}

enum LoanStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  IN_ARREARS
  PAID
  DEFAULTED
  LOSS
}

enum InstallmentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  EXTENDED
}

enum PaymentFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum PaymentMethod {
  CASH
  TRANSFER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalType {
  NEW_CLIENT
  NEW_LOAN
  EXPENSE
  CASH_BASE_REQUEST
  PAYMENT_EXTENSION
  WRITE_OFF
}

enum ExpenseType {
  OPERATIONAL
  TRANSPORT
  OTHER
}

enum CashRegisterType {
  MAIN
  ROUTE
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum SyncStatus {
  PENDING
  SYNCED
  CONFLICT
  ERROR
}

// ============================================
// MÓDULO AUTH / USUARIOS / ROLES
// ============================================

model User {
  id                String      @id @default(uuid())
  email             String      @unique @db.VarChar(255)
  passwordHash      String      @db.VarChar(255)
  firstName         String      @db.VarChar(100)
  lastName          String      @db.VarChar(100)
  phone             String?     @db.VarChar(20)
  role              UserRole
  status            UserStatus  @default(ACTIVE)
  lastLoginAt       DateTime?
  failedLoginAttempts Int       @default(0)
  mustChangePassword Boolean   @default(false)
  
  // Auditoría
  createdById       String?     // Self-reference para saber quién creó el usuario
  createdBy         User?       @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers      User[]      @relation("UserCreatedBy")
  
  // Relaciones
  userRoles         UserRoleAssignment[]
  auditLogs         AuditLog[]
  createdClients    Client[]    @relation("ClientCreatedBy")
  approvedClients   Client[]    @relation("ClientApprovedBy")
  createdLoans      Loan[]      @relation("LoanCreatedBy")
  approvedLoans     Loan[]      @relation("LoanApprovedBy")
  payments          Payment[]
  routeAssignments  RouteAssignment[]
  approvals         Approval[]
  expenses          Expense[]
  cashRegisters     CashRegister[]
  transactions      Transaction[]
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  deletedAt         DateTime?
  
  // Sincronización (para Opción A/B)
  syncStatus        SyncStatus  @default(PENDING)
  lastSyncedAt      DateTime?
  syncError         String?     @db.Text
  
  @@index([email])
  @@index([role])
  @@index([status])
  @@index([syncStatus])
}

model Role {
  id          String    @id @default(uuid())
  name        String    @unique @db.VarChar(50)
  description String?   @db.VarChar(255)
  isSystem    Boolean   @default(false) // Para proteger roles del sistema
  
  // Relaciones
  permissions RolePermission[]
  userRoles   UserRoleAssignment[]
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  
  @@index([name])
  @@map("roles")
}

model Permission {
  id          String    @id @default(uuid())
  module      String    @db.VarChar(50)  // Ej: "clients", "loans", "payments"
  action      String    @db.VarChar(50)  // Ej: "create", "read", "update", "delete", "approve"
  description String?   @db.VarChar(255)
  
  // Relaciones
  rolePermissions RolePermission[]
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([module, action])
  @@index([module])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  
  // Relaciones
  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])
  
  // Timestamps
  createdAt    DateTime   @default(now())
  
  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model UserRoleAssignment {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  
  // Relaciones
  user      User     @relation(fields: [userId], references: [id])
  role      Role     @relation(fields: [roleId], references: [id])
  
  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime? // Para asignaciones temporales
  
  @@unique([userId, roleId])
  @@index([userId])
  @@map("user_role_assignments")
}

// ============================================
// MÓDULO CLIENTES
// ============================================

model Client {
  id              String      @id @default(uuid())
  code            String      @unique @db.VarChar(20) // Código interno
  dni             String      @unique @db.VarChar(20)
  firstName       String      @db.VarChar(100)
  lastName        String      @db.VarChar(100)
  email           String?     @db.VarChar(255)
  phone           String      @db.VarChar(20)
  address         String?     @db.Text
  reference       String?     @db.Text // Referencias personales
  
  // Semáforo de riesgo
  riskLevel       RiskLevel   @default(GREEN)
  score           Int         @default(100) // 0-100
  lastRiskUpdate  DateTime?   // Cuándo se actualizó el riesgo
  
  // Lista negra
  isBlacklisted   Boolean     @default(false)
  blacklistReason String?     @db.Text
  blacklistedAt   DateTime?
  blacklistedById String?     // Quién lo blacklisteó
  
  // Auditoría y aprobación
  createdById     String      // Cobrador que lo creó
  approvedById    String?     // Coordinador que lo aprobó
  status          ApprovalStatus @default(PENDING)
  
  // Relaciones
  createdBy       User        @relation("ClientCreatedBy", fields: [createdById], references: [id])
  approvedBy      User?       @relation("ClientApprovedBy", fields: [approvedById], references: [id])
  loans           Loan[]
  routeAssignments RouteAssignment[]
  payments        Payment[]
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  deletedAt       DateTime?
  
  // Sincronización
  syncStatus      SyncStatus  @default(PENDING)
  lastSyncedAt    DateTime?
  
  @@index([dni])
  @@index([riskLevel])
  @@index([isBlacklisted])
  @@index([status])
  @@index([createdById])
  @@index([syncStatus])
}

// ============================================
// MÓDULO INVENTARIO / ARTÍCULOS
// ============================================

model Product {
  id            String      @id @default(uuid())
  code          String      @unique @db.VarChar(50)
  name          String      @db.VarChar(255)
  description   String?     @db.Text
  category      String      @db.VarChar(100)
  brand         String?     @db.VarChar(100)
  model         String?     @db.VarChar(100)
  cost          Decimal     @db.Decimal(10, 2) // Costo de compra
  stock         Int         @default(0)
  minStock      Int         @default(0)
  isActive      Boolean     @default(true)
  
  // Relaciones
  prices        ProductPrice[]
  loans         Loan[]
  
  // Timestamps
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  deletedAt     DateTime?
  
  @@index([code])
  @@index([category])
  @@index([isActive])
}

model ProductPrice {
  id          String    @id @default(uuid())
  productId   String
  months      Int       // Plazo en meses
  price       Decimal   @db.Decimal(10, 2) // Precio final a crédito
  isActive    Boolean   @default(true)
  
  // Relaciones
  product     Product   @relation(fields: [productId], references: [id])
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@unique([productId, months])
  @@index([productId])
  @@index([months])
  @@map("product_prices")
}

// ============================================
// MÓDULO PRÉSTAMOS / CRÉDITOS
// ============================================

model Loan {
  id                String            @id @default(uuid())
  loanNumber        String            @unique @db.VarChar(50)
  clientId          String
  productId         String?           // Si es préstamo por artículo
  productPriceId    String?           // Precio específico según plazo
  
  // Tipo de préstamo
  loanType          String            @db.VarChar(20) // "CASH", "APPLIANCE"
  amount            Decimal           @db.Decimal(12, 2) // Monto total del préstamo
  interestRate      Decimal           @db.Decimal(5, 2) // Tasa de interés mensual
  lateInterestRate  Decimal           @db.Decimal(5, 2) // Tasa por mora
  
  // Plazos y frecuencia
  termMonths        Int               // Plazo en meses
  paymentFrequency  PaymentFrequency
  installmentsCount Int               // Número total de cuotas
  startDate         DateTime
  endDate           DateTime
  
  // Estado y aprobación
  status            LoanStatus        @default(DRAFT)
  createdById       String            // Cobrador que lo creó
  approvedById      String?           // Coordinador que lo aprobó
  approvalStatus    ApprovalStatus    @default(PENDING)
  
  // Campos financieros calculados
  totalInterest     Decimal           @db.Decimal(12, 2) @default(0)
  totalPaid         Decimal           @db.Decimal(12, 2) @default(0)
  totalCapitalPaid  Decimal           @db.Decimal(12, 2) @default(0)
  totalInterestPaid Decimal           @db.Decimal(12, 2) @default(0)
  totalLateInterest Decimal           @db.Decimal(12, 2) @default(0)
  remainingBalance  Decimal           @db.Decimal(12, 2) @default(0)
  
  // Relaciones
  client            Client            @relation(fields: [clientId], references: [id])
  product           Product?          @relation(fields: [productId], references: [id])
  productPrice      ProductPrice?     @relation(fields: [productPriceId], references: [id])
  createdBy         User              @relation("LoanCreatedBy", fields: [createdById], references: [id])
  approvedBy        User?             @relation("LoanApprovedBy", fields: [approvedById], references: [id])
  installments      Installment[]
  payments          Payment[]
  extensions        PaymentExtension[]
  
  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  deletedAt         DateTime?
  
  // Sincronización
  syncStatus        SyncStatus        @default(PENDING)
  lastSyncedAt      DateTime?
  
  @@index([loanNumber])
  @@index([clientId])
  @@index([status])
  @@index([approvalStatus])
  @@index([createdById])
  @@index([syncStatus])
  @@index([startDate])
  @@index([endDate])
}

model Installment {
  id                String          @id @default(uuid())
  loanId            String
  installmentNumber Int             // Número de cuota (1, 2, 3...)
  dueDate           DateTime
  amount            Decimal         @db.Decimal(10, 2) // Monto total de la cuota
  capitalAmount     Decimal         @db.Decimal(10, 2) // Parte de capital
  interestAmount    Decimal         @db.Decimal(10, 2) // Parte de interés normal
  lateInterestAmount Decimal        @db.Decimal(10, 2) @default(0) // Interés por mora
  
  // Estado de pago
  status            InstallmentStatus @default(PENDING)
  paidAmount        Decimal         @db.Decimal(10, 2) @default(0)
  paidDate          DateTime?
  
  // Prórroga
  extendedDueDate   DateTime?       // Nueva fecha si se extendió
  extensionId       String?         // Relación a la extensión aprobada
  
  // Relaciones
  loan              Loan            @relation(fields: [loanId], references: [id])
  paymentDetails    PaymentDetail[]
  extension         PaymentExtension? @relation(fields: [extensionId], references: [id])
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@unique([loanId, installmentNumber])
  @@index([loanId])
  @@index([dueDate])
  @@index([status])
  @@index([extendedDueDate])
  @@map("installments")
}

model PaymentExtension {
  id                String          @id @default(uuid())
  loanId            String
  installmentId     String?         // Si es específica a una cuota
  originalDueDate   DateTime
  newDueDate        DateTime
  reason            String?         @db.Text
  approvedById      String          // Coordinador que aprobó
  
  // Relaciones
  loan              Loan            @relation(fields: [loanId], references: [id])
  installment       Installment?    @relation(fields: [installmentId], references: [id])
  approvedBy        User            @relation(fields: [approvedById], references: [id])
  approvals         Approval[]      // Para trazabilidad
  
  // Timestamps
  createdAt         DateTime        @default(now())
  
  @@index([loanId])
  @@index([approvedById])
  @@map("payment_extensions")
}

// ============================================
// MÓDULO PAGOS
// ============================================

model Payment {
  id                String          @id @default(uuid())
  paymentNumber     String          @unique @db.VarChar(50)
  clientId          String
  loanId            String
  collectorId       String          // Cobrador que registró el pago
  
  // Información del pago
  paymentDate       DateTime        @default(now())
  totalAmount       Decimal         @db.Decimal(10, 2)
  paymentMethod     PaymentMethod
  referenceNumber   String?         @db.VarChar(100) // Para transferencias
  notes             String?         @db.Text         // Comentarios de visita
  
  // Relaciones
  client            Client          @relation(fields: [clientId], references: [id])
  loan              Loan            @relation(fields: [loanId], references: [id])
  collector         User            @relation(fields: [collectorId], references: [id])
  paymentDetails    PaymentDetail[]
  receipt           Receipt?
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Sincronización
  syncStatus        SyncStatus      @default(PENDING)
  lastSyncedAt      DateTime?
  
  @@index([paymentNumber])
  @@index([clientId])
  @@index([loanId])
  @@index([collectorId])
  @@index([paymentDate])
  @@index([syncStatus])
}

model PaymentDetail {
  id              String          @id @default(uuid())
  paymentId       String
  installmentId   String
  amount          Decimal         @db.Decimal(10, 2)
  capitalAmount   Decimal         @db.Decimal(10, 2) // Cuánto se abonó a capital
  interestAmount  Decimal         @db.Decimal(10, 2) // Cuánto se abonó a interés normal
  lateInterestAmount Decimal      @db.Decimal(10, 2) // Cuánto se abonó a interés por mora
  
  // Relaciones
  payment         Payment         @relation(fields: [paymentId], references: [id])
  installment     Installment     @relation(fields: [installmentId], references: [id])
  
  // Timestamps
  createdAt       DateTime        @default(now())
  
  @@unique([paymentId, installmentId])
  @@index([paymentId])
  @@index([installmentId])
  @@map("payment_details")
}

model Receipt {
  id              String          @id @default(uuid())
  paymentId       String          @unique
  receiptNumber   String          @unique @db.VarChar(50)
  content         Json            // Datos del recibo en formato estructurado
  pdfPath         String?         @db.VarChar(500) // Ruta al PDF generado
  sharedVia       String?         @db.VarChar(50)  // Ej: "WHATSAPP", "EMAIL"
  sharedAt        DateTime?
  
  // Relaciones
  payment         Payment         @relation(fields: [paymentId], references: [id])
  
  // Timestamps
  createdAt       DateTime        @default(now())
  
  @@index([receiptNumber])
  @@index([paymentId])
  @@map("receipts")
}

// ============================================
// MÓDULO RUTAS
// ============================================

model Route {
  id              String          @id @default(uuid())
  code            String          @unique @db.VarChar(20)
  name            String          @db.VarChar(255)
  description     String?         @db.Text
  zone            String          @db.VarChar(100)
  isActive        Boolean         @default(true)
  
  // Asignación
  collectorId     String          // Cobrador asignado
  supervisorId    String?         // Supervisor responsable
  
  // Relaciones
  collector       User            @relation("RouteCollector", fields: [collectorId], references: [id])
  supervisor      User?           @relation("RouteSupervisor", fields: [supervisorId], references: [id])
  routeAssignments RouteAssignment[]
  cashRegister    CashRegister[]  // Caja de ruta asociada
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([code])
  @@index([collectorId])
  @@index([supervisorId])
  @@index([isActive])
  @@map("routes")
}

model RouteAssignment {
  id              String          @id @default(uuid())
  routeId         String
  clientId        String
  collectorId     String          // Duplicado para consultas rápidas
  dayOfWeek       Int?            // 0-6 (Domingo=0) si es recurrente
  specificDate    DateTime?       // Si es asignación específica
  visitOrder      Int             @default(0) // Para ordenamiento Drag & Drop
  isActive        Boolean         @default(true)
  
  // Relaciones
  route           Route           @relation(fields: [routeId], references: [id])
  client          Client          @relation(fields: [clientId], references: [id])
  collector       User            @relation(fields: [collectorId], references: [id])
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([routeId, clientId, specificDate])
  @@index([routeId])
  @@index([clientId])
  @@index([collectorId])
  @@index([dayOfWeek])
  @@index([specificDate])
  @@index([visitOrder])
  @@map("route_assignments")
}

// ============================================
// MÓDULO APROBACIONES
// ============================================

model Approval {
  id              String          @id @default(uuid())
  approvalType    ApprovalType
  referenceId     String          // ID del registro a aprobar
  referenceTable  String          @db.VarChar(50) // Nombre de la tabla
  
  // Solicitud
  requestedById   String          // Quién lo solicitó
  requestedData   Json            // Datos originales de la solicitud
  
  // Aprobación
  approvedById    String?         // Quién lo aprobó/rechazó
  approvalStatus  ApprovalStatus  @default(PENDING)
  comments        String?         @db.Text
  approvedData    Json?           // Datos aprobados (si hubo modificaciones)
  
  // Relaciones
  requestedBy     User            @relation("ApprovalRequestedBy", fields: [requestedById], references: [id])
  approvedBy      User?           @relation("ApprovalApprovedBy", fields: [approvedById], references: [id])
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  reviewedAt      DateTime?
  
  // Sincronización
  syncStatus      SyncStatus      @default(PENDING)
  
  @@index([approvalType])
  @@index([referenceId, referenceTable])
  @@index([requestedById])
  @@index([approvedById])
  @@index([approvalStatus])
  @@index([createdAt])
  @@index([syncStatus])
  @@map("approvals")
}

// ============================================
// MÓDULO CONTABILIDAD / CAJAS
// ============================================

model CashRegister {
  id              String          @id @default(uuid())
  code            String          @unique @db.VarChar(20)
  name            String          @db.VarChar(255)
  type            CashRegisterType
  routeId         String?         // Solo para cajas de ruta
  currentBalance  Decimal         @db.Decimal(12, 2) @default(0)
  minBalance      Decimal         @db.Decimal(12, 2) @default(0)
  maxBalance      Decimal         @db.Decimal(12, 2) @default(0)
  isActive        Boolean         @default(true)
  
  // Responsable
  responsibleId   String          // Usuario responsable
  
  // Relaciones
  route           Route?          @relation(fields: [routeId], references: [id])
  responsible     User            @relation(fields: [responsibleId], references: [id])
  transactions    Transaction[]
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([code])
  @@index([type])
  @@index([routeId])
  @@index([responsibleId])
  @@map("cash_registers")
}

model Transaction {
  id                String          @id @default(uuid())
  transactionNumber String          @unique @db.VarChar(50)
  cashRegisterId    String
  type              TransactionType
  amount            Decimal         @db.Decimal(12, 2)
  
  // Referencia
  referenceType     String?         @db.VarChar(50) // "PAYMENT", "EXPENSE", "TRANSFER"
  referenceId       String?         // ID del registro relacionado
  
  // Descripción
  description       String          @db.Text
  notes             String?         @db.Text
  
  // Auditoría
  createdById       String
  approvedById      String?         // Para gastos que requieren aprobación
  
  // Relaciones
  cashRegister      CashRegister    @relation(fields: [cashRegisterId], references: [id])
  createdBy         User            @relation(fields: [createdById], references: [id])
  approvedBy        User?           @relation(fields: [approvedById], references: [id])
  
  // Timestamps
  transactionDate   DateTime        @default(now())
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Sincronización
  syncStatus        SyncStatus      @default(PENDING)
  
  @@index([transactionNumber])
  @@index([cashRegisterId])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([createdById])
  @@index([transactionDate])
  @@index([syncStatus])
}

model Expense {
  id              String          @id @default(uuid())
  expenseNumber   String          @unique @db.VarChar(50)
  routeId         String?         // Si es gasto de ruta
  collectorId     String          // Cobrador que reportó
  cashRegisterId  String          // Caja de donde se descuenta
  
  // Información del gasto
  expenseType     ExpenseType
  amount          Decimal         @db.Decimal(10, 2)
  description     String          @db.Text
  receiptPhoto    String?         @db.VarChar(500) // URL de foto de recibo
  
  // Aprobación
  approvedById    String?         // Supervisor que aprobó
  approvalStatus  ApprovalStatus  @default(PENDING)
  
  // Relaciones
  route           Route?          @relation(fields: [routeId], references: [id])
  collector       User            @relation(fields: [collectorId], references: [id])
  cashRegister    CashRegister    @relation(fields: [cashRegisterId], references: [id])
  approvedBy      User?           @relation(fields: [approvedById], references: [id])
  approvals       Approval[]
  transaction     Transaction?    @relation(fields: [cashRegisterId], references: [cashRegisterId])
  
  // Timestamps
  expenseDate     DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Sincronización
  syncStatus      SyncStatus      @default(PENDING)
  
  @@index([expenseNumber])
  @@index([routeId])
  @@index([collectorId])
  @@index([approvalStatus])
  @@index([expenseDate])
  @@index([syncStatus])
}

// ============================================
// MÓDULO AUDITORÍA
// ============================================

model AuditLog {
  id              String          @id @default(uuid())
  userId          String?
  userRole        UserRole?
  
  // Acción
  action          String          @db.VarChar(100) // "CREATE", "UPDATE", "DELETE", "APPROVE", etc.
  entity          String          @db.VarChar(50)  // Nombre de la tabla
  entityId        String?         // ID del registro afectado
  
  // Cambios
  oldValues       Json?           // Valores anteriores
  newValues       Json?           // Valores nuevos
  changes         Json?           // Diferencias estructuradas
  
  // Contexto
  ipAddress       String?         @db.VarChar(45)
  userAgent       String?         @db.Text
  endpoint        String?         @db.VarChar(500)
  
  // Relaciones
  user            User?           @relation(fields: [userId], references: [id])
  
  // Timestamps
  createdAt       DateTime        @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// MÓDULO SINCRONIZACIÓN (Para Opción B)
// ============================================

model SyncQueue {
  id              String          @id @default(uuid())
  tableName       String          @db.VarChar(50)
  recordId        String
  operation       String          @db.VarChar(10) // "CREATE", "UPDATE", "DELETE"
  data            Json            // Datos completos del registro
  status          SyncStatus      @default(PENDING)
  attempts        Int             @default(0)
  lastAttemptAt   DateTime?
  errorMessage    String?         @db.Text
  
  // Contexto
  createdByDevice String?         @db.VarChar(100) // Identificador del dispositivo
  createdByUserId String?         // Usuario que realizó la acción
  
  // Relaciones
  user            User?           @relation(fields: [createdByUserId], references: [id])
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([tableName, recordId])
  @@index([status])
  @@index([createdAt])
  @@map("sync_queue")
}